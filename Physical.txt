คุม
/*
 * Controller Robot (Sender)
 * ระบบ: UNO + NRF24 + HC-SR04 + Motor Turret + 4 Buttons
 */
#include <SPI.h>
#include <nRF24L01.h>
#include <RF24.h>

// --- ตั้งค่า NRF24L01 ---
RF24 radio(9, 10); // CE, CSN
const byte address[6] = "00001";

// --- ตั้งค่าขามอเตอร์ฐาน ---
const int TURRET_IN1 = 2;
const int TURRET_IN2 = 3;

// --- ตั้งค่าขา Sensor วัดระยะ ---
const int TRIG_PIN = 6;
const int ECHO_PIN = 7;

// --- ตั้งค่าขาปุ่มกด (Analog Pins ใช้เป็น Digital Input) ---
const int BTN_LEFT  = A0; // K1 หมุนซ้าย
const int BTN_SEND  = A1; // K2 วัดระยะและส่งค่า
const int BTN_RESET = A2; // K3 (เผื่อไว้)
const int BTN_RIGHT = A3; // K4 หมุนขวา

void setup() {
  Serial.begin(9600);
  
  // Setup Motor
  pinMode(TURRET_IN1, OUTPUT);
  pinMode(TURRET_IN2, OUTPUT);
  
  // Setup HC-SR04
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  
  // Setup Buttons (INPUT_PULLUP: กด=LOW, ไม่กด=HIGH)
  pinMode(BTN_LEFT, INPUT_PULLUP);
  pinMode(BTN_SEND, INPUT_PULLUP);
  pinMode(BTN_RESET, INPUT_PULLUP);
  pinMode(BTN_RIGHT, INPUT_PULLUP);
  
  // Setup Radio
  if (!radio.begin()) {
    Serial.println("NRF24 Hardware Error!");
    while(1); // ค้างไว้ถ้า NRF เสีย
  }
  radio.openWritingPipe(address);
  radio.setPALevel(RF24_PA_MAX);
  radio.stopListening(); // โหมดส่ง
  
  Serial.println("Controller Ready...");
}

void loop() {
  // 1. ควบคุมการหมุน (กดแช่เพื่อหมุน)
  if (digitalRead(BTN_LEFT) == LOW) {
    digitalWrite(TURRET_IN1, HIGH);
    digitalWrite(TURRET_IN2, LOW);
  } 
  else if (digitalRead(BTN_RIGHT) == LOW) {
    digitalWrite(TURRET_IN1, LOW);
    digitalWrite(TURRET_IN2, HIGH);
  } 
  else {
    digitalWrite(TURRET_IN1, LOW);
    digitalWrite(TURRET_IN2, LOW);
  }

  // 2. กดปุ่ม K2 เพื่อวัดระยะและส่ง
  if (digitalRead(BTN_SEND) == LOW) {
    // วัดระยะ
    float distance = getDistance();
    
    Serial.print("Sending Distance: ");
    Serial.print(distance);
    Serial.println(" cm");
    
    // ส่งข้อมูล
    bool report = radio.write(&distance, sizeof(float));
    
    if (report) Serial.println("-> Send OK");
    else Serial.println("-> Send Fail");
    
    delay(500); // ดีเลย์ป้องกันกดรัว
  }
}

float getDistance() {
  digitalWrite(TRIG_PIN, LOW); delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH); delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);
  long duration = pulseIn(ECHO_PIN, HIGH);
  return duration * 0.034 / 2;
}

รถ
/*
 * Vehicle Robot (Receiver)
 * ระบบ: Nano + NRF24 + L298N (2 Motors)
 */
#include <SPI.h>
#include <nRF24L01.h>
#include <RF24.h>

// --- ตั้งค่า NRF24L01 ---
RF24 radio(9, 10); // CE, CSN
const byte address[6] = "00001";

// --- ตั้งค่าขา Motor Driver (L298N) ---
const int ENA = 2; // Speed Left
const int IN1 = 3;
const int IN2 = 4;
const int IN3 = 5;
const int IN4 = 6;
const int ENB = 7; // Speed Right

// ค่าความเร็วมอเตอร์ (0-255)
const int MOTOR_SPEED = 200; 

void setup() {
  Serial.begin(9600);
  
  // Setup Motors pins
  pinMode(ENA, OUTPUT); pinMode(ENB, OUTPUT);
  pinMode(IN1, OUTPUT); pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT); pinMode(IN4, OUTPUT);
  
  // หยุดมอเตอร์ก่อน
  stopMotors();

  // Setup Radio
  if (!radio.begin()) {
    Serial.println("NRF24 Hardware Error!");
    while(1);
  }
  radio.openReadingPipe(0, address);
  radio.setPALevel(RF24_PA_MAX);
  radio.startListening(); // โหมดรับ
  
  Serial.println("Vehicle Ready...");
}

void loop() {
  if (radio.available()) {
    float distance = 0.0;
    radio.read(&distance, sizeof(float)); // รับค่าระยะทาง
    
    Serial.print("Received: "); Serial.println(distance);
    
    // --- เงื่อนไขตามที่กำหนด ---
    
    // 1. ระยะ 4.5 - 5.5 cm : ล้อขวาเดินหน้า (เลี้ยวซ้าย)
    if (distance >= 4.5 && distance <= 5.5) {
      Serial.println("CMD: Turn Left");
      moveLeft();
      delay(1000); 
      stopMotors();
    }
    // 2. ระยะ 9.5 - 10.5 cm : เดินหน้าทั้งคู่
    else if (distance >= 9.5 && distance <= 10.5) {
      Serial.println("CMD: Forward");
      moveForward();
      delay(1000);
      stopMotors();
    }
    // 3. ระยะ 14.5 - 15.5 cm : ถอยหลังทั้งคู่
    else if (distance >= 14.5 && distance <= 15.5) {
      Serial.println("CMD: Backward");
      moveBackward();
      delay(1000);
      stopMotors();
    }
    // 4. ระยะ 19.5 - 20.5 cm : ล้อซ้ายเดินหน้า (เลี้ยวขวา)
    else if (distance >= 19.5 && distance <= 20.5) {
      Serial.println("CMD: Turn Right");
      moveRight();
      delay(1000);
      stopMotors();
    }
    // ระยะอื่นๆ : หยุดนิ่ง
    else {
      stopMotors();
    }
  }
}

// --- ฟังก์ชั่นควบคุมมอเตอร์ ---
void moveForward() {
  analogWrite(ENA, MOTOR_SPEED);
  digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW);
  
  analogWrite(ENB, MOTOR_SPEED);
  digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW);
}

void moveBackward() {
  analogWrite(ENA, MOTOR_SPEED);
  digitalWrite(IN1, LOW); digitalWrite(IN2, HIGH);
  
  analogWrite(ENB, MOTOR_SPEED);
  digitalWrite(IN3, LOW); digitalWrite(IN4, HIGH);
}

void moveLeft() {
  // เลี้ยวซ้าย: ล้อซ้ายหยุด ล้อขวาเดินหน้า
  analogWrite(ENA, 0);
  digitalWrite(IN1, LOW); digitalWrite(IN2, LOW);
  
  analogWrite(ENB, MOTOR_SPEED);
  digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW);
}

void moveRight() {
  // เลี้ยวขวา: ล้อซ้ายเดินหน้า ล้อขวาหยุด
  analogWrite(ENA, MOTOR_SPEED);
  digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW);
  
  analogWrite(ENB, 0);
  digitalWrite(IN3, LOW); digitalWrite(IN4, LOW);
}

void stopMotors() {
  digitalWrite(ENA, LOW);
  digitalWrite(ENB, LOW);
  digitalWrite(IN1, LOW); digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW); digitalWrite(IN4, LOW);
}
